<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Edge Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-danger { background: #dc2626; color: white; }
        textarea, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin: 8px 0; }
        .game-card { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; margin: 10px 0; }
        .game-card.high { border-left: 4px solid #10b981; }
        .game-card.med { border-left: 4px solid #f59e0b; }
        .score { font-size: 32px; font-weight: 900; color: #2563eb; }
        .hidden { display: none !important; }
        .modal-visible { display: flex !important; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="login-screen" class="container" style="text-align: center; padding-top: 100px;">
    <h1 style="font-size: 36px; margin-bottom: 10px;">üèÄ NBA Edge Tracker</h1>
    <p style="color: #666; margin-bottom: 30px;">Contrarian betting intelligence</p>
    <button onclick="doSignIn()" class="btn-primary" style="font-size: 16px; padding: 16px 32px;">
        Sign in with Google
    </button>
</div>

<div id="app-screen" class="hidden">
    <div style="background: white; padding: 16px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="font-size: 20px;">üèÄ NBA Edge</h2>
                <p id="user-info" style="font-size: 12px; color: #666;"></p>
            </div>
            <button onclick="doSignOut()" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">Exit</button>
        </div>
    </div>

    <div class="container">
        <!-- Performance Dashboard -->
        <div id="perf-dash"></div>

        <!-- Import Section -->
        <div class="card">
            <h3 style="margin-bottom: 16px;">Import from SBD</h3>
            <input type="date" id="game-date" style="width: auto; margin-bottom: 10px;">
            <textarea id="spread-data" rows="6" placeholder="Paste SPREAD table data here"></textarea>
            <textarea id="ml-data" rows="6" placeholder="Paste MONEYLINE table data here"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="importGames()" class="btn-primary">Import Games</button>
                <button onclick="clearGames()" class="btn-danger">Clear All</button>
            </div>
        </div>

        <!-- Games List -->
        <div id="games-container"></div>
    </div>

    <!-- Result Modal -->
    <div id="modal-overlay" onclick="if(event.target === this) closeModal();" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px;">
            <h3 style="margin-bottom: 16px;">Log Result</h3>
            <p id="modal-info" style="color: #666; margin-bottom: 16px;"></p>
            <input type="number" id="team-score" placeholder="Team Score">
            <input type="number" id="opp-score" placeholder="Opponent Score">
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button onclick="saveResult()" class="btn-primary" style="flex: 1;">Save</button>
                <button onclick="closeModal()" style="flex: 1; background: #9ca3af; color: white;">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB8EmsdGFvQLRRWev3zM8wzSXXhgWjHeO4",
    authDomain: "nba-tracker-641f0.firebaseapp.com",
    databaseURL: "https://nba-tracker-641f0-default-rtdb.firebaseio.com",
    projectId: "nba-tracker-641f0",
    storageBucket: "nba-tracker-641f0.firebasestorage.app",
    messagingSenderId: "29717054876",
    appId: "1:29717054876:web:fc4bf3d1242967fe857459"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let games = [];
let results = [];
let currentGameKey = null;

// Auth
function doSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => {
        console.log('Popup failed, using redirect');
        auth.signInWithRedirect(provider);
    });
}

function doSignOut() {
    auth.signOut();
}

auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('user-info').textContent = user.email;
        loadData();
    } else {
        currentUser = null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-screen').classList.add('hidden');
    }
});

// Load data
function loadData() {
    db.ref('games').on('value', snap => {
        games = [];
        snap.forEach(child => {
            games.push({ key: child.key, ...child.val() });
        });
        render();
    });

    db.ref('results').on('value', snap => {
        results = [];
        snap.forEach(child => {
            results.push({ key: child.key, ...child.val() });
        });
        render();
    });
}

// Calculate ML baseline
function calcMLBaseline(spread) {
    return Math.max(5, Math.min(95, 50 + (parseFloat(spread) * -2.8)));
}

// Calculate fit score
function calcFitScore(game) {
    // Handle both old and new field names
    const spreadPct = game.spreadMoneyPct || game.spreadPct || 0;
    const mlPct = game.mlMoneyPct || game.mlPct || 0;
    const spread = game.spread || 0;
    
    const spreadBase = 50;
    const mlBase = calcMLBaseline(spread);
    const spreadGap = spreadBase - spreadPct;
    const mlGap = mlBase - mlPct;
    const weighted = (spreadGap * 0.70) + (mlGap * 0.30);
    const base = Math.max(0, weighted * 1.5);
    const aligned = spreadGap > 0 && mlGap > 0;
    const bonus = aligned ? 5 : 0;
    return {
        score: Math.round((base + bonus) * 10) / 10,
        spreadGap: Math.round(spreadGap * 10) / 10,
        mlGap: Math.round(mlGap * 10) / 10,
        aligned
    };
}

// Parse SBD data
function parseSBD(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    const parsed = [];
    let i = 0;
    
    while (i < lines.length) {
        const teamMatch = lines[i].match(/logo([A-Z]{2,4})$/);
        if (teamMatch) {
            const team = teamMatch[1];
            i++;
            while (i < lines.length && lines[i].toLowerCase().includes('logo')) i++;
            if (i >= lines.length) break;
            
            const lineVal = parseFloat(lines[i].replace('‚àí', '-').replace('+', ''));
            i += 2; // skip bet%
            if (i >= lines.length) break;
            
            const pct = parseFloat(lines[i].replace('%', ''));
            parsed.push({ team, line: lineVal, pct });
        }
        i++;
    }
    
    // Pair opponents
    for (let j = 0; j < parsed.length; j += 2) {
        if (j + 1 < parsed.length) {
            parsed[j].opp = parsed[j + 1].team;
            parsed[j + 1].opp = parsed[j].team;
        }
    }
    
    return parsed;
}

// Import games
function importGames() {
    const spreadText = document.getElementById('spread-data').value;
    const mlText = document.getElementById('ml-data').value;
    const date = document.getElementById('game-date').value;
    
    if (!spreadText || !mlText) {
        alert('Paste both spread and ML data');
        return;
    }
    
    const spreadData = parseSBD(spreadText);
    const mlData = parseSBD(mlText);
    
    if (spreadData.length === 0 || mlData.length === 0) {
        alert('Parse failed');
        return;
    }
    
    // Delete existing games for this date
    const deletes = games.filter(g => g.date === date).map(g => db.ref('games/' + g.key).remove());
    
    Promise.all(deletes).then(() => {
        const promises = [];
        spreadData.forEach(s => {
            const m = mlData.find(x => x.team === s.team);
            if (m) {
                promises.push(db.ref('games').push({
                    team: s.team,
                    opponent: s.opp,
                    spread: s.line,
                    moneyline: m.line,
                    spreadMoneyPct: s.pct,
                    mlMoneyPct: m.pct,
                    date: date,
                    addedBy: currentUser.email,
                    addedAt: Date.now()
                }));
            }
        });
        
        Promise.all(promises).then(() => {
            document.getElementById('spread-data').value = '';
            document.getElementById('ml-data').value = '';
            alert('Imported ' + promises.length + ' games!');
        });
    });
}

// Clear games
function clearGames() {
    if (confirm('Clear all games? Results will be kept.')) {
        db.ref('games').remove();
    }
}

// Open modal
function openModal(key) {
    currentGameKey = key;
    const game = games.find(g => g.key === key);
    document.getElementById('modal-info').textContent = `${game.team} vs ${game.opponent}`;
    const modal = document.getElementById('modal-overlay');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

// Close modal
function closeModal() {
    currentGameKey = null;
    document.getElementById('team-score').value = '';
    document.getElementById('opp-score').value = '';
    document.getElementById('modal-overlay').style.display = 'none';
}

// Save result
function saveResult() {
    const ts = parseInt(document.getElementById('team-score').value);
    const os = parseInt(document.getElementById('opp-score').value);
    
    if (isNaN(ts) || isNaN(os)) {
        alert('Enter both scores');
        return;
    }
    
    const game = games.find(g => g.key === currentGameKey);
    const margin = ts - os;
    const analysis = calcFitScore(game);
    
    const resultData = {
        team: game.team,
        opponent: game.opponent,
        date: game.date,
        spread: game.spread,
        moneyline: game.moneyline,
        spreadMoneyPct: game.spreadMoneyPct || game.spreadPct,
        mlMoneyPct: game.mlMoneyPct || game.mlPct,
        teamScore: ts,
        oppScore: os,
        margin: margin,
        spreadResult: (margin + game.spread > 0) ? 'WIN' : 'LOSS',
        mlResult: margin > 0 ? 'WIN' : 'LOSS',
        fitScore: analysis.score,
        spreadGap: analysis.spreadGap,
        mlGap: analysis.mlGap,
        aligned: analysis.aligned,
        loggedBy: currentUser.email,
        loggedAt: Date.now()
    };
    
    game.result = {
        teamScore: ts,
        oppScore: os,
        spreadResult: resultData.spreadResult,
        mlResult: resultData.mlResult
    };
    
    Promise.all([
        db.ref('games/' + game.key).update(game),
        db.ref('results').push(resultData)
    ]).then(() => {
        closeModal();
        alert('Result saved!');
    });
}

// Render
function render() {
    renderPerformance();
    renderGames();
}

function renderPerformance() {
    const qualified = results.filter(r => r.fitScore >= 20);
    if (qualified.length === 0) {
        document.getElementById('perf-dash').innerHTML = '';
        return;
    }
    
    let sW = 0, sT = 0, mW = 0, mT = 0, sP = 0, mP = 0;
    
    qualified.forEach(r => {
        if (r.spreadGap > 0) {
            sT++;
            if (r.spreadResult === 'WIN') { sW++; sP += 100; } else { sP -= 110; }
        }
        if (r.mlGap > 0) {
            mT++;
            if (r.mlResult === 'WIN') {
                mW++;
                const ml = r.moneyline;
                mP += ml > 0 ? ml : (100/Math.abs(ml))*100;
            } else {
                mP -= 100;
            }
        }
    });
    
    const total = sP + mP;
    const html = `
        <div class="card" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white;">
            <h3 style="margin-bottom: 16px;">System Performance</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">Spread</div>
                    <div style="font-size: 24px; font-weight: 900;">${sW}-${sT-sW}</div>
                    <div style="font-size: 12px;">${sT > 0 ? ((sW/sT)*100).toFixed(0) : 0}%</div>
                </div>
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">ML</div>
                    <div style="font-size: 24px; font-weight: 900;">${mW}-${mT-mW}</div>
                    <div style="font-size: 12px;">${mT > 0 ? ((mW/mT)*100).toFixed(0) : 0}%</div>
                </div>
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">Profit</div>
                    <div style="font-size: 24px; font-weight: 900;">${total >= 0 ? '+' : ''}$${total.toFixed(0)}</div>
                    <div style="font-size: 12px;">${qualified.length} games</div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('perf-dash').innerHTML = html;
}

function renderGames() {
    const sorted = [...games].sort((a, b) => {
        const aScore = calcFitScore(a).score;
        const bScore = calcFitScore(b).score;
        return bScore - aScore;
    });
    
    if (sorted.length === 0) {
        document.getElementById('games-container').innerHTML = '<div class="card"><p style="text-align: center; color: #666;">No games yet. Import from SBD above.</p></div>';
        return;
    }
    
    let html = '';
    sorted.forEach((game, i) => {
        const analysis = calcFitScore(game);
        const tier = analysis.score >= 50 ? 'high' : analysis.score >= 25 ? 'med' : '';
        
        html += `
            <div class="game-card ${tier}">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <div style="font-size: 20px; font-weight: 700;">#${i+1} ${game.team}</div>
                        <div style="color: #666; margin-top: 4px;">
                            ${game.spread > 0 ? '+' : ''}${game.spread} vs ${game.opponent} | ML ${game.moneyline > 0 ? '+' : ''}${game.moneyline}
                        </div>
                        ${analysis.aligned ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-top: 8px; display: inline-block;">‚≠ê ALIGNED</span>' : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="score">${analysis.score}</div>
                        <div style="font-size: 10px; color: #666;">FIT SCORE</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 16px 0;">
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 12px; font-weight: 600; color: #666;">SPREAD</div>
                        <div style="margin-top: 8px; font-size: 13px;">Gap: <span style="color: ${analysis.spreadGap > 0 ? '#10b981' : '#ef4444'}; font-weight: 700;">${analysis.spreadGap > 0 ? '+' : ''}${analysis.spreadGap}%</span></div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <div style="font-size: 12px; font-weight: 600; color: #666;">ML</div>
                        <div style="margin-top: 8px; font-size: 13px;">Gap: <span style="color: ${analysis.mlGap > 0 ? '#10b981' : '#ef4444'}; font-weight: 700;">${analysis.mlGap > 0 ? '+' : ''}${analysis.mlGap}%</span></div>
                    </div>
                </div>
                ${game.result ? `
                    <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                        <div style="font-weight: 600; margin-bottom: 8px;">${game.team} ${game.result.teamScore} - ${game.opponent} ${game.result.oppScore}</div>
                        <span style="background: ${game.result.spreadResult === 'WIN' ? '#dcfce7' : '#fee2e2'}; color: ${game.result.spreadResult === 'WIN' ? '#10b981' : '#ef4444'}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-right: 8px;">ATS: ${game.result.spreadResult}</span>
                        <span style="background: ${game.result.mlResult === 'WIN' ? '#dcfce7' : '#fee2e2'}; color: ${game.result.mlResult === 'WIN' ? '#10b981' : '#ef4444'}; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">ML: ${game.result.mlResult}</span>
                    </div>
                ` : `
                    <button onclick="openModal('${game.key}')" class="btn-primary" style="width: 100%; margin-top: 12px;">Log Result</button>
                `}
            </div>
        `;
    });
    
    document.getElementById('games-container').innerHTML = html;
}

// Set today's date
document.getElementById('game-date').valueAsDate = new Date();
</script>

</body>
</html>
