<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Edge Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { 
            background: rgba(30, 41, 59, 0.6); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.3); 
        }
        button { padding: 12px 24px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { 
            background: linear-gradient(135deg, #3b82f6, #8b5cf6); 
            color: white; 
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        textarea, input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid rgba(148, 163, 184, 0.2); 
            border-radius: 10px; 
            font-size: 14px; 
            margin: 8px 0; 
            background: rgba(30, 41, 59, 0.4);
            color: white;
        }
        textarea::placeholder, input::placeholder { color: #94a3b8; }
        .game-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.8));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px; 
            padding: 20px; 
            margin: 14px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        .game-card:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0,0,0,0.5); }
        .game-card.high { border-left: 4px solid #10b981; }
        .game-card.med { border-left: 4px solid #f59e0b; }
        .score { 
            font-size: 40px; 
            font-weight: 900; 
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .score.high { background: linear-gradient(135deg, #10b981, #34d399); -webkit-background-clip: text; }
        .score.med { background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; }
        .hidden { display: none !important; }
        .stat-box {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            border-radius: 12px;
            padding: 14px;
        }
    </style>
</head>
<body>

<div id="login-screen" class="container" style="text-align: center; padding-top: 100px;">
    <div style="margin-bottom: 24px;">
        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 24px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);">
            <span style="font-size: 50px;">üèÄ</span>
        </div>
        <h1 style="font-size: 42px; margin-bottom: 12px; font-weight: 900; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NBA EDGE</h1>
        <p style="color: #94a3b8; font-size: 16px; margin-bottom: 40px;">Contrarian betting intelligence</p>
    </div>
    <button onclick="doSignIn()" class="btn-primary" style="font-size: 16px; padding: 16px 48px;">
        Sign in with Google
    </button>
</div>

<div id="app-screen" class="hidden">
    <div style="background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); padding: 16px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.3); margin-bottom: 20px; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 20px;">üèÄ</span>
                </div>
                <div>
                    <h2 style="font-size: 20px; font-weight: 800; color: white;">NBA EDGE</h2>
                    <p id="user-info" style="font-size: 11px; color: #94a3b8;"></p>
                </div>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button onclick="showCalibration()" style="font-size: 22px; background: none; border: none; cursor: pointer; padding: 4px; filter: grayscale(0.3) brightness(1.2);" title="Score Calibration">üìä</button>
                <button onclick="showOptimizer()" style="font-size: 22px; background: none; border: none; cursor: pointer; padding: 4px; filter: grayscale(0.3) brightness(1.2);" title="Optimize Weights">‚öôÔ∏è</button>
                <button onclick="showPerformance()" style="font-size: 24px; background: none; border: none; cursor: pointer; padding: 4px; filter: grayscale(0.3) brightness(1.2);">üìà</button>
                <button onclick="doSignOut()" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">Exit</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Performance Dashboard -->
        <div id="perf-dash"></div>

        <!-- Import Section -->
        <div class="card">
            <h3 style="margin-bottom: 16px; color: white; font-size: 18px; font-weight: 700;">Import from SBD</h3>
            <input type="date" id="game-date" style="width: auto; margin-bottom: 10px;">
            <textarea id="spread-data" rows="6" placeholder="Paste SPREAD table data here"></textarea>
            <textarea id="ml-data" rows="6" placeholder="Paste MONEYLINE table data here"></textarea>
            <div style="display: flex; gap: 10px;">
                <button onclick="importGames()" class="btn-primary">Import Games</button>
                <button onclick="clearGames()" class="btn-danger">Clear All</button>
            </div>
        </div>

        <!-- Games List -->
        <div id="games-container"></div>
    </div>

    <!-- Result Modal -->
    <div id="modal-overlay" onclick="if(event.target === this) closeModal();" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px;">
            <h3 style="margin-bottom: 16px;">Log Result</h3>
            <p id="modal-info" style="color: #666; margin-bottom: 16px;"></p>
            <input type="number" id="team-score" placeholder="Team Score" oninput="autofillOpponent()">
            <input type="number" id="opp-score" placeholder="Opponent Score" oninput="autofillTeam()">
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button onclick="saveResult()" class="btn-primary" style="flex: 1;">Save</button>
                <button onclick="closeModal()" style="flex: 1; background: #9ca3af; color: white;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Performance Modal -->
    <div id="perf-modal" onclick="if(event.target === this) closePerfModal();" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 20px; padding: 32px; max-width: 900px; margin: 20px auto; border: 1px solid rgba(148, 163, 184, 0.2); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üìà Performance Analytics</h3>
                <button onclick="closePerfModal()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 10px; font-size: 20px; cursor: pointer; transition: all 0.2s;">&times;</button>
            </div>
            
            <!-- Filters -->
            <div style="background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 24px;">
                <div style="font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;">üéØ Filters</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 8px; font-weight: 600;">Score Range</label>
                        <select id="perf-score-filter" onchange="showPerformance()" style="width: 100%; padding: 12px; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 10px; background: rgba(15, 23, 42, 0.8); color: white; font-size: 14px; font-weight: 500;">
                            <option value=">0">Any Edge (>0)</option>
                            <option value="10+">10+</option>
                            <option value="20+">20+</option>
                            <option value="30+">30+</option>
                            <option value="40+">40+</option>
                            <option value="50+">50+</option>
                            <option value="0-10">0-10</option>
                            <option value="10-20">10-20</option>
                            <option value="20-30">20-30</option>
                            <option value="30-40">30-40</option>
                            <option value="40-50">40-50</option>
                            <option value="50+range">50+</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8; display: block; margin-bottom: 8px; font-weight: 600;">Time Period</label>
                        <select id="perf-date-filter" onchange="showPerformance()" style="width: 100%; padding: 12px; border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 10px; background: rgba(15, 23, 42, 0.8); color: white; font-size: 14px; font-weight: 500;">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="3">Last 3 Days</option>
                            <option value="5">Last 5 Days</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="perf-modal-content"></div>
        </div>
    </div>
    
    <!-- Optimizer Modal -->
    <div id="optimizer-modal" onclick="if(event.target === this) closeOptimizer();" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1001; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 20px; padding: 32px; max-width: 900px; margin: 20px auto; border: 1px solid rgba(148, 163, 184, 0.2); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">‚öôÔ∏è Weight Optimizer</h3>
                <button onclick="closeOptimizer()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 10px; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div id="optimizer-content"></div>
        </div>
    </div>
    
    <!-- Calibration Modal -->
    <div id="calibration-modal" onclick="if(event.target === this) closeCalibration();" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1001; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-radius: 20px; padding: 32px; max-width: 1000px; margin: 20px auto; border: 1px solid rgba(148, 163, 184, 0.2); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üìä Score Calibration</h3>
                <button onclick="closeCalibration()" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; width: 36px; height: 36px; border-radius: 10px; font-size: 20px; cursor: pointer;">&times;</button>
            </div>
            <div id="calibration-content"></div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyB8EmsdGFvQLRRWev3zM8wzSXXhgWjHeO4",
    authDomain: "nba-tracker-641f0.firebaseapp.com",
    databaseURL: "https://nba-tracker-641f0-default-rtdb.firebaseio.com",
    projectId: "nba-tracker-641f0",
    storageBucket: "nba-tracker-641f0.firebasestorage.app",
    messagingSenderId: "29717054876",
    appId: "1:29717054876:web:fc4bf3d1242967fe857459"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let games = [];
let results = [];
let currentGameKey = null;

// Auth
function doSignIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(err => {
        console.log('Popup failed, using redirect');
        auth.signInWithRedirect(provider);
    });
}

function doSignOut() {
    auth.signOut();
}

auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('user-info').textContent = user.email;
        loadData();
    } else {
        currentUser = null;
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('app-screen').classList.add('hidden');
    }
});

// Load data
function loadData() {
    db.ref('games').on('value', snap => {
        games = [];
        snap.forEach(child => {
            games.push({ key: child.key, ...child.val() });
        });
        render();
    });

    db.ref('results').on('value', snap => {
        results = [];
        snap.forEach(child => {
            results.push({ key: child.key, ...child.val() });
        });
        render();
    });
}

// Calculate ML baseline
function calcMLBaseline(spread) {
    return Math.max(5, Math.min(95, 50 + (parseFloat(spread) * -2.8)));
}

// Calculate fit score
function calcFitScore(game) {
    // Handle both old and new field names
    const spreadPct = game.spreadMoneyPct || game.spreadPct || 0;
    const mlPct = game.mlMoneyPct || game.mlPct || 0;
    const spread = game.spread || 0;
    
    const spreadBase = 50;
    const mlBase = calcMLBaseline(spread);
    let spreadGap = spreadBase - spreadPct;
    let mlGap = mlBase - mlPct;
    
    // Invert gaps if using FADE strategy
    if (currentWeights.invert) {
        spreadGap = -spreadGap;
        mlGap = -mlGap;
    }
    
    const weighted = (spreadGap * currentWeights.spreadWeight) + (mlGap * currentWeights.mlWeight);
    const base = weighted * currentWeights.multiplier;  // Removed floor - allows negative scores
    const aligned = spreadGap > 0 && mlGap > 0;
    const bonus = aligned ? currentWeights.alignmentBonus : 0;
    return {
        score: Math.round((base + bonus) * 10) / 10,
        spreadGap: Math.round(spreadGap * 10) / 10,
        mlGap: Math.round(mlGap * 10) / 10,
        aligned
    };
}

// Parse SBD data
function parseSBD(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    const parsed = [];
    let i = 0;
    
    while (i < lines.length) {
        const teamMatch = lines[i].match(/logo([A-Z]{2,4})$/);
        if (teamMatch) {
            const team = teamMatch[1];
            i++;
            while (i < lines.length && lines[i].toLowerCase().includes('logo')) i++;
            if (i >= lines.length) break;
            
            const lineVal = parseFloat(lines[i].replace('‚àí', '-').replace('+', ''));
            i += 2; // skip bet%
            if (i >= lines.length) break;
            
            const pct = parseFloat(lines[i].replace('%', ''));
            parsed.push({ team, line: lineVal, pct });
        }
        i++;
    }
    
    // Pair opponents
    for (let j = 0; j < parsed.length; j += 2) {
        if (j + 1 < parsed.length) {
            parsed[j].opp = parsed[j + 1].team;
            parsed[j + 1].opp = parsed[j].team;
        }
    }
    
    return parsed;
}

// Import games
function importGames() {
    const spreadText = document.getElementById('spread-data').value;
    const mlText = document.getElementById('ml-data').value;
    const date = document.getElementById('game-date').value;
    
    if (!spreadText || !mlText) {
        alert('Paste both spread and ML data');
        return;
    }
    
    const spreadData = parseSBD(spreadText);
    const mlData = parseSBD(mlText);
    
    if (spreadData.length === 0 || mlData.length === 0) {
        alert('Parse failed');
        return;
    }
    
    // Delete existing games for this date
    const deletes = games.filter(g => g.date === date).map(g => db.ref('games/' + g.key).remove());
    
    Promise.all(deletes).then(() => {
        const promises = [];
        spreadData.forEach(s => {
            const m = mlData.find(x => x.team === s.team);
            if (m) {
                promises.push(db.ref('games').push({
                    team: s.team,
                    opponent: s.opp,
                    spread: s.line,
                    moneyline: m.line,
                    spreadMoneyPct: s.pct,
                    mlMoneyPct: m.pct,
                    date: date,
                    addedBy: currentUser.email,
                    addedAt: Date.now()
                }));
            }
        });
        
        Promise.all(promises).then(() => {
            document.getElementById('spread-data').value = '';
            document.getElementById('ml-data').value = '';
            alert('Imported ' + promises.length + ' games!');
        });
    });
}

// Clear games
function clearGames() {
    if (confirm('Clear all games? Results will be kept.')) {
        db.ref('games').remove();
    }
}

// Open modal
function openModal(key) {
    currentGameKey = key;
    const game = games.find(g => g.key === key);
    document.getElementById('modal-info').textContent = `${game.team} vs ${game.opponent}`;
    const modal = document.getElementById('modal-overlay');
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
}

// Autofill helpers
function autofillOpponent() {
    const teamVal = document.getElementById('team-score').value;
    const oppInput = document.getElementById('opp-score');
    if (teamVal && !oppInput.value) {
        oppInput.value = teamVal;
    }
}

function autofillTeam() {
    const oppVal = document.getElementById('opp-score').value;
    const teamInput = document.getElementById('team-score');
    if (oppVal && !teamInput.value) {
        teamInput.value = oppVal;
    }
}

// Close modal
function closeModal() {
    currentGameKey = null;
    document.getElementById('team-score').value = '';
    document.getElementById('opp-score').value = '';
    document.getElementById('modal-overlay').style.display = 'none';
}

// Show performance
function showPerformance() {
    console.log('Total results in database:', results.length);
    console.log('Results data:', results);
    
    if (results.length === 0) {
        alert('No results logged yet. Results array is empty.');
        return;
    }
    
    // Show modal first
    document.getElementById('perf-modal').style.display = 'block';
    
    // Get filter values (with defaults)
    const scoreFilter = document.getElementById('perf-score-filter')?.value || 'all';
    const dateRange = document.getElementById('perf-date-filter')?.value || 'all';
    
    console.log('Filters - Score:', scoreFilter, 'Date Range:', dateRange);
    
    // Apply filters
    let filtered = [...results];
    
    // Score filter
    if (scoreFilter === '>0') {
        filtered = filtered.filter(r => r.fitScore > 0);
    } else if (scoreFilter.includes('+')) {
        // Handle 10+, 20+, 30+, 40+, 50+
        const min = parseInt(scoreFilter);
        filtered = filtered.filter(r => r.fitScore >= min);
    } else if (scoreFilter.includes('-')) {
        // Handle ranges like 0-10, 10-20, etc.
        const [min, max] = scoreFilter.split('-').map(n => parseInt(n));
        filtered = filtered.filter(r => r.fitScore >= min && r.fitScore < max);
    } else if (scoreFilter === '50+range') {
        filtered = filtered.filter(r => r.fitScore >= 50);
    }
    
    // Date filter
    if (dateRange !== 'all') {
        if (dateRange === 'today') {
            // Today only - start of today to now
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            filtered = filtered.filter(r => r.loggedAt >= todayStart.getTime());
        } else if (dateRange === 'yesterday') {
            // Yesterday only - start to end of yesterday
            const yesterdayStart = new Date();
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
            yesterdayStart.setHours(0, 0, 0, 0);
            const yesterdayEnd = new Date();
            yesterdayEnd.setDate(yesterdayEnd.getDate() - 1);
            yesterdayEnd.setHours(23, 59, 59, 999);
            filtered = filtered.filter(r => r.loggedAt >= yesterdayStart.getTime() && r.loggedAt <= yesterdayEnd.getTime());
        } else {
            // Last N days
            const cutoff = Date.now() - (parseInt(dateRange) * 24 * 60 * 60 * 1000);
            filtered = filtered.filter(r => r.loggedAt >= cutoff);
        }
    }
    
    console.log('After filters:', filtered.length, 'results');
    
    if (filtered.length === 0) {
        document.getElementById('perf-modal-content').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No results match these filters</p>';
        return;
    }
    
    const qualified10 = results.filter(r => r.fitScore >= 10);
    
    let sW = 0, sT = 0, mW = 0, mT = 0, sP = 0, mP = 0;
    
    filtered.forEach(r => {
        if (r.spreadGap > 0) {
            sT++;
            if (r.spreadResult === 'WIN') { 
                sW++; 
                sP += 100;
                console.log(`Spread WIN: ${r.team} - Added $100, total now: $${sP}`);
            } else { 
                sP -= 110;
                console.log(`Spread LOSS: ${r.team} - Lost $110, total now: $${sP}`);
            }
        }
        if (r.mlGap > 0) {
            mT++;
            if (r.mlResult === 'WIN') {
                mW++;
                const ml = r.moneyline;
                const profit = ml > 0 ? ml : (100/Math.abs(ml))*100;
                mP += profit;
                console.log(`ML WIN: ${r.team} at ${ml} - Added $${profit.toFixed(2)}, total now: $${mP.toFixed(2)}`);
            } else {
                mP -= 100;
                console.log(`ML LOSS: ${r.team} - Lost $100, total now: $${mP.toFixed(2)}`);
            }
        }
    });
    
    console.log('Final spread profit:', sP);
    console.log('Final ML profit:', mP);
    
    const total = sP + mP;
    
    let html = `
        <div style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <h4 style="margin-bottom: 16px; font-size: 16px;">Overall (${filtered.length} games, ${qualified10.length} total 10+)</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-size: 11px; opacity: 0.8;">SPREAD</div>
                    <div style="font-size: 28px; font-weight: 900;">${sW}-${sT-sW}</div>
                    <div style="font-size: 13px;">${sT > 0 ? ((sW/sT)*100).toFixed(0) : 0}% ‚Ä¢ $${sP.toFixed(0)}</div>
                </div>
                <div>
                    <div style="font-size: 11px; opacity: 0.8;">ML</div>
                    <div style="font-size: 28px; font-weight: 900;">${mW}-${mT-mW}</div>
                    <div style="font-size: 13px;">${mT > 0 ? ((mW/mT)*100).toFixed(0) : 0}% ‚Ä¢ $${mP.toFixed(0)}</div>
                </div>
                <div>
                    <div style="font-size: 11px; opacity: 0.8;">TOTAL</div>
                    <div style="font-size: 28px; font-weight: 900;">${total >= 0 ? '+' : ''}$${total.toFixed(0)}</div>
                    <div style="font-size: 13px;">${sT + mT} bets</div>
                </div>
            </div>
        </div>
        
        <h4 style="font-size: 14px; font-weight: 700; color: #94a3b8; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Results (${filtered.length})</h4>
    `;
    
    const sorted = [...filtered].sort((a, b) => b.loggedAt - a.loggedAt);
    sorted.forEach(r => {
        const isWin = r.spreadResult === 'WIN' || r.mlResult === 'WIN';
        html += `
            <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.6)); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${isWin ? '#10b981' : '#ef4444'}; border: 1px solid rgba(148, 163, 184, 0.15); transition: all 0.2s; position: relative;">
                <button onclick="deleteResult('${r.key}')" style="position: absolute; top: 12px; right: 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; width: 28px; height: 28px; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 700;">√ó</button>
                <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px; color: white; padding-right: 40px;">${r.team} ${r.teamScore}-${r.oppScore} ${r.opponent}</div>
                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 10px;">
                    <span style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; padding: 2px 8px; border-radius: 6px; font-weight: 600; font-size: 11px; margin-right: 6px;">SCORE: ${r.fitScore}</span>
                    <span style="color: #64748b;">ML: ${r.moneyline}</span> ‚Ä¢ 
                    <span style="color: #64748b;">Spread Gap: ${r.spreadGap}%</span> ‚Ä¢ 
                    <span style="color: #64748b;">ML Gap: ${r.mlGap}%</span>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    ${r.spreadGap > 0 ? `<span style="font-size: 12px; padding: 6px 12px; border-radius: 8px; background: ${r.spreadResult === 'WIN' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${r.spreadResult === 'WIN' ? '#10b981' : '#ef4444'}; font-weight: 700; border: 1px solid ${r.spreadResult === 'WIN' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">ATS: ${r.spreadResult}</span>` : ''}
                    ${r.mlGap > 0 ? `<span style="font-size: 12px; padding: 6px 12px; border-radius: 8px; background: ${r.mlResult === 'WIN' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${r.mlResult === 'WIN' ? '#10b981' : '#ef4444'}; font-weight: 700; border: 1px solid ${r.mlResult === 'WIN' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">ML: ${r.mlResult}</span>` : ''}
                </div>
            </div>
        `;
    });
    
    document.getElementById('perf-modal-content').innerHTML = html;
}

function closePerfModal() {
    document.getElementById('perf-modal').style.display = 'none';
}

// Delete result
function deleteResult(resultKey) {
    if (!confirm('Delete this result? You can re-log it after.')) {
        return;
    }
    
    // Find the result to get game info
    const resultToDelete = results.find(r => r.key === resultKey);
    if (!resultToDelete) {
        alert('Result not found');
        return;
    }
    
    // Find the corresponding game
    const gameWithResult = games.find(g => 
        g.team === resultToDelete.team && 
        g.opponent === resultToDelete.opponent && 
        g.date === resultToDelete.date
    );
    
    const promises = [
        db.ref('results/' + resultKey).remove()
    ];
    
    // Remove result from game card (but keep the game)
    if (gameWithResult && gameWithResult.result) {
        promises.push(db.ref('games/' + gameWithResult.key + '/result').remove());
    }
    
    Promise.all(promises)
        .then(() => {
            console.log('Result deleted:', resultKey);
            closePerfModal();
            alert('Result deleted. Refreshing page...');
            location.reload();
        })
        .catch(err => {
            console.error('Delete failed:', err);
            alert('Failed to delete: ' + err.message);
        });
}

// Optimizer functions
let currentWeights = { spreadWeight: 0.70, mlWeight: 0.30, alignmentBonus: 5, multiplier: 1.5, invert: false };

function showOptimizer() {
    if (results.length < 10) {
        alert('Need at least 10 logged results to optimize weights');
        return;
    }
    
    document.getElementById('optimizer-modal').style.display = 'block';
    
    const html = `
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: white; margin-bottom: 12px;">Current Weights</h4>
            <div style="color: #94a3b8; font-size: 14px; line-height: 1.8;">
                Spread: <span style="color: white; font-weight: 700;">${(currentWeights.spreadWeight * 100).toFixed(0)}%</span><br>
                ML: <span style="color: white; font-weight: 700;">${(currentWeights.mlWeight * 100).toFixed(0)}%</span><br>
                Alignment Bonus: <span style="color: white; font-weight: 700;">+${currentWeights.alignmentBonus}</span><br>
                Multiplier: <span style="color: white; font-weight: 700;">${currentWeights.multiplier}x</span>
            </div>
        </div>
        
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 20px;">
            <p style="color: #94a3b8; font-size: 14px; line-height: 1.6; margin-bottom: 16px;">
                The optimizer will test <strong style="color: white;">1,620 different weight combinations</strong> on your ${results.length} logged games to find which settings would have maximized profit.
            </p>
            <button onclick="runOptimizer()" class="btn-primary" style="width: 100%;">
                üöÄ Run Optimization
            </button>
        </div>
        
        <div id="optimizer-results"></div>
    `;
    
    document.getElementById('optimizer-content').innerHTML = html;
}

function closeOptimizer() {
    document.getElementById('optimizer-modal').style.display = 'none';
}

// Calibration functions
function showCalibration() {
    if (results.length < 10) {
        alert('Need at least 10 logged results for calibration analysis');
        return;
    }
    
    document.getElementById('calibration-modal').style.display = 'block';
    
    // Define score ranges
    const ranges = [
        { label: '‚â§0 (No Edge)', min: -Infinity, max: 0.01 },
        { label: '>0-10', min: 0.01, max: 10 },
        { label: '10-20', min: 10, max: 20 },
        { label: '20-30', min: 20, max: 30 },
        { label: '30-40', min: 30, max: 40 },
        { label: '40-50', min: 40, max: 50 },
        { label: '50+', min: 50, max: Infinity }
    ];
    
    // Calculate performance for each range
    const rangeStats = ranges.map(range => {
        const gamesInRange = results.filter(r => r.fitScore >= range.min && r.fitScore < range.max);
        
        let sW = 0, sT = 0, mW = 0, mT = 0, sP = 0, mP = 0;
        
        gamesInRange.forEach(r => {
            if (r.spreadGap > 0) {
                sT++;
                if (r.spreadResult === 'WIN') { sW++; sP += 100; } else { sP -= 110; }
            }
            if (r.mlGap > 0) {
                mT++;
                if (r.mlResult === 'WIN') {
                    mW++;
                    const ml = r.moneyline;
                    mP += ml > 0 ? ml : (100/Math.abs(ml))*100;
                } else {
                    mP -= 100;
                }
            }
        });
        
        const totalBets = sT + mT;
        const totalWins = sW + mW;
        const totalProfit = sP + mP;
        const winPct = totalBets > 0 ? (totalWins / totalBets) * 100 : 0;
        
        return {
            label: range.label,
            count: gamesInRange.length,
            spreadRecord: `${sW}-${sT-sW}`,
            mlRecord: `${mW}-${mT-mW}`,
            totalBets,
            winPct: winPct.toFixed(1),
            profit: totalProfit,
            avgProfit: totalBets > 0 ? (totalProfit / totalBets).toFixed(2) : 0
        };
    });
    
    let html = `
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 20px;">
            <p style="color: #94a3b8; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">
                This shows which score ranges are actually profitable. Use this to determine your betting threshold.
            </p>
        </div>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; color: white;">
                <thead>
                    <tr style="background: rgba(30, 41, 59, 0.6); border-bottom: 2px solid rgba(148, 163, 184, 0.2);">
                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Score Range</th>
                        <th style="padding: 12px; text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Games</th>
                        <th style="padding: 12px; text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Total Bets</th>
                        <th style="padding: 12px; text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Win %</th>
                        <th style="padding: 12px; text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Spread</th>
                        <th style="padding: 12px; text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase;">ML</th>
                        <th style="padding: 12px; text-align: right; font-size: 12px; color: #94a3b8; text-transform: uppercase;">Profit</th>
                        <th style="padding: 12px; text-align: right; font-size: 12px; color: #94a3b8; text-transform: uppercase;">$/Bet</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    rangeStats.forEach((stat, i) => {
        if (stat.count === 0) return;
        
        const profitColor = stat.profit >= 0 ? '#10b981' : '#ef4444';
        const rowBg = i % 2 === 0 ? 'rgba(30, 41, 59, 0.3)' : 'rgba(15, 23, 42, 0.3)';
        
        html += `
            <tr style="background: ${rowBg}; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">
                <td style="padding: 14px; font-weight: 600;">${stat.label}</td>
                <td style="padding: 14px; text-align: center;">${stat.count}</td>
                <td style="padding: 14px; text-align: center; font-weight: 600;">${stat.totalBets}</td>
                <td style="padding: 14px; text-align: center; font-weight: 700; color: ${stat.winPct >= 52.4 ? '#10b981' : '#ef4444'};">${stat.winPct}%</td>
                <td style="padding: 14px; text-align: center; font-size: 13px;">${stat.spreadRecord}</td>
                <td style="padding: 14px; text-align: center; font-size: 13px;">${stat.mlRecord}</td>
                <td style="padding: 14px; text-align: right; font-weight: 700; font-size: 16px; color: ${profitColor};">${stat.profit >= 0 ? '+' : ''}$${stat.profit.toFixed(0)}</td>
                <td style="padding: 14px; text-align: right; font-weight: 600; color: ${stat.avgProfit >= 0 ? '#10b981' : '#ef4444'};">${stat.avgProfit >= 0 ? '+' : ''}$${stat.avgProfit}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px; margin-top: 20px;">
            <div style="font-size: 12px; color: #60a5fa; font-weight: 700; margin-bottom: 8px;">üí° KEY INSIGHTS</div>
            <ul style="color: #cbd5e1; font-size: 14px; line-height: 1.8; margin: 0; padding-left: 20px;">
                <li>Win % of <strong>52.4%+</strong> is needed to break even at -110 juice</li>
                <li>Look for ranges with positive <strong>$/Bet</strong> - those are profitable</li>
                <li>Consider only betting score ranges that show consistent profit</li>
            </ul>
        </div>
    `;
    
    document.getElementById('calibration-content').innerHTML = html;
}

function closeCalibration() {
    document.getElementById('calibration-modal').style.display = 'none';
}

function runOptimizer() {
    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ Optimizing...';
    
    setTimeout(() => {
        console.log('Starting optimization with', results.length, 'results');
        
        // Test both contrarian and fade scenarios
        const strategies = [
            { name: 'Contrarian', invert: false },
            { name: 'Fade (Bet WITH Public)', invert: true }
        ];
        
        const spreadWeights = [0.50, 0.55, 0.60, 0.65, 0.70, 0.75, 0.80, 0.85, 0.90];
        const alignmentBonuses = [-10, -5, 0, 2.5, 5, 7.5, 10];
        const multipliers = [1.0, 1.25, 1.5, 1.75, 2.0];
        
        let bestProfit = -Infinity;
        let bestCombo = null;
        let allResults = [];
        
        // Test all combinations for both strategies
        strategies.forEach(strategy => {
            spreadWeights.forEach(sw => {
                const mw = 1 - sw;
                alignmentBonuses.forEach(bonus => {
                    multipliers.forEach(mult => {
                        const profit = simulateProfit(sw, mw, bonus, mult, strategy.invert);
                        const combo = { 
                            sw, mw, bonus, mult, profit,
                            strategy: strategy.name,
                            invert: strategy.invert
                        };
                        allResults.push(combo);
                        
                        if (profit > bestProfit) {
                            bestProfit = profit;
                            bestCombo = combo;
                        }
                    });
                });
            });
        });
        
        console.log('Optimization complete. Best profit:', bestProfit);
        console.log('Best combo:', bestCombo);
        
        displayOptimizerResults(bestCombo, allResults);
        button.disabled = false;
        button.textContent = 'üöÄ Run Optimization';
    }, 100);
}

function simulateProfit(spreadWeight, mlWeight, alignmentBonus, multiplier, invertGaps) {
    let totalProfit = 0;
    
    results.forEach(r => {
        // Recalculate fit score with these weights
        const spreadPct = r.spreadMoneyPct || r.spreadPct || 0;
        const mlPct = r.mlMoneyPct || r.mlPct || 0;
        const spread = r.spread || 0;
        
        const spreadBase = 50;
        const mlBase = Math.max(5, Math.min(95, 50 + (parseFloat(spread) * -2.8)));
        
        let spreadGap = spreadBase - spreadPct;
        let mlGap = mlBase - mlPct;
        
        // INVERT if testing "fade" strategy
        if (invertGaps) {
            spreadGap = -spreadGap;
            mlGap = -mlGap;
        }
        
        const weighted = (spreadGap * spreadWeight) + (mlGap * mlWeight);
        const base = weighted * multiplier;  // Removed floor - allows negative scores
        const aligned = spreadGap > 0 && mlGap > 0;
        const fitScore = base + (aligned ? alignmentBonus : 0);
        
        // Only bet if score >= 10
        if (fitScore >= 10) {
            if (spreadGap > 0) {
                totalProfit += r.spreadResult === 'WIN' ? 100 : -110;
            }
            if (mlGap > 0) {
                if (r.mlResult === 'WIN') {
                    const ml = r.moneyline;
                    totalProfit += ml > 0 ? ml : (100/Math.abs(ml))*100;
                } else {
                    totalProfit -= 100;
                }
            }
        }
    });
    
    return totalProfit;
}

function displayOptimizerResults(best, all) {
    const currentProfit = simulateProfit(
        currentWeights.spreadWeight, 
        currentWeights.mlWeight, 
        currentWeights.alignmentBonus, 
        currentWeights.multiplier,
        false
    );
    
    const improvement = best.profit - currentProfit;
    const improvementPct = currentProfit !== 0 ? ((improvement / Math.abs(currentProfit)) * 100) : 0;
    
    // Sort all results to show top 5
    all.sort((a, b) => b.profit - a.profit);
    const top5 = all.slice(0, 5);
    
    // Get best contrarian vs best fade
    const bestContrarian = all.filter(c => !c.invert).sort((a,b) => b.profit - a.profit)[0];
    const bestFade = all.filter(c => c.invert).sort((a,b) => b.profit - a.profit)[0];
    
    let html = `
        <div style="background: linear-gradient(135deg, ${best.invert ? '#dc2626' : '#10b981'}, ${best.invert ? '#ef4444' : '#34d399'}); border-radius: 14px; padding: 24px; margin-bottom: 20px;">
            <h4 style="color: white; font-size: 18px; margin-bottom: 8px;">‚ú® Optimal Strategy: ${best.strategy}</h4>
            <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 16px;">
                ${best.invert ? '‚ö†Ô∏è Your best results come from BETTING WITH THE PUBLIC, not against them!' : '‚úÖ Contrarian betting works - fade the public!'}
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Spread Weight</div>
                    <div style="font-size: 24px; font-weight: 900; color: white;">${(best.sw * 100).toFixed(0)}%</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">ML Weight</div>
                    <div style="font-size: 24px; font-weight: 900; color: white;">${(best.mw * 100).toFixed(0)}%</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Alignment Bonus</div>
                    <div style="font-size: 24px; font-weight: 900; color: white;">${best.bonus > 0 ? '+' : ''}${best.bonus}</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 12px;">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.8);">Multiplier</div>
                    <div style="font-size: 24px; font-weight: 900; color: white;">${best.mult}x</div>
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.2); border-radius: 10px; padding: 16px;">
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 4px;">Historical Profit with Optimal Weights</div>
                <div style="font-size: 32px; font-weight: 900; color: white;">${best.profit >= 0 ? '+' : ''}$${best.profit.toFixed(0)}</div>
                <div style="font-size: 14px; color: rgba(255,255,255,0.9); margin-top: 8px;">
                    ${improvement >= 0 ? '+' : ''}$${improvement.toFixed(0)} vs current (${improvementPct >= 0 ? '+' : ''}${improvementPct.toFixed(1)}%)
                </div>
            </div>
        </div>
        
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: white; margin-bottom: 16px;">Strategy Comparison</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 16px;">
                    <div style="font-size: 12px; color: #10b981; font-weight: 700; margin-bottom: 8px;">CONTRARIAN (Fade Public)</div>
                    <div style="font-size: 28px; font-weight: 900; color: ${bestContrarian.profit >= 0 ? '#10b981' : '#ef4444'};">
                        ${bestContrarian.profit >= 0 ? '+' : ''}$${bestContrarian.profit.toFixed(0)}
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                        ${(bestContrarian.sw*100).toFixed(0)}% Spread / ${(bestContrarian.mw*100).toFixed(0)}% ML
                    </div>
                </div>
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 16px;">
                    <div style="font-size: 12px; color: #ef4444; font-weight: 700; margin-bottom: 8px;">FADE (Bet WITH Public)</div>
                    <div style="font-size: 28px; font-weight: 900; color: ${bestFade.profit >= 0 ? '#10b981' : '#ef4444'};">
                        ${bestFade.profit >= 0 ? '+' : ''}$${bestFade.profit.toFixed(0)}
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">
                        ${(bestFade.sw*100).toFixed(0)}% Spread / ${(bestFade.mw*100).toFixed(0)}% ML
                    </div>
                </div>
            </div>
        </div>
        
        <div style="background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: white; margin-bottom: 12px;">Top 5 Combinations (All Strategies)</h4>
    `;
    
    top5.forEach((combo, i) => {
        html += `
            <div style="background: rgba(15, 23, 42, 0.6); border-radius: 10px; padding: 12px; margin-bottom: 8px; border-left: 3px solid ${i === 0 ? '#10b981' : '#3b82f6'};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="color: ${combo.invert ? '#ef4444' : '#10b981'}; font-size: 11px; font-weight: 700; margin-bottom: 4px;">${combo.strategy.toUpperCase()}</div>
                        <div style="color: #94a3b8; font-size: 13px;">
                            Spread ${(combo.sw*100).toFixed(0)}% / ML ${(combo.mw*100).toFixed(0)}% / Bonus ${combo.bonus > 0 ? '+' : ''}${combo.bonus} / Mult ${combo.mult}x
                        </div>
                    </div>
                    <div style="color: ${combo.profit >= 0 ? '#10b981' : '#ef4444'}; font-weight: 700; font-size: 16px;">
                        ${combo.profit >= 0 ? '+' : ''}$${combo.profit.toFixed(0)}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
        <button onclick="applyOptimalWeights(${best.sw}, ${best.mw}, ${best.bonus}, ${best.mult}, ${best.invert})" class="btn-primary" style="width: 100%;">
            Apply Optimal Weights (${best.strategy})
        </button>
    `;
    
    document.getElementById('optimizer-results').innerHTML = html;
}

function applyOptimalWeights(sw, mw, bonus, mult, invert) {
    const strategy = invert ? 'FADE (Bet WITH Public)' : 'CONTRARIAN (Fade Public)';
    if (!confirm(`Apply ${strategy} weights?\n\nSpread: ${(sw*100).toFixed(0)}%\nML: ${(mw*100).toFixed(0)}%\nAlignment Bonus: ${bonus > 0 ? '+' : ''}${bonus}\nMultiplier: ${mult}x\n\nThis will recalculate all current game scores.`)) {
        return;
    }
    
    currentWeights = { 
        spreadWeight: sw, 
        mlWeight: mw, 
        alignmentBonus: bonus, 
        multiplier: mult,
        invert: invert
    };
    
    alert(`${strategy} weights applied! Refresh the page to see updated fit scores.`);
    closeOptimizer();
    
    // Re-render games with new weights
    render();
}

function closePerfModal() {
    document.getElementById('perf-modal').style.display = 'none';
}

// Save result
function saveResult() {
    const ts = parseInt(document.getElementById('team-score').value);
    const os = parseInt(document.getElementById('opp-score').value);
    
    if (isNaN(ts) || isNaN(os)) {
        alert('Enter both scores');
        return;
    }
    
    if (!currentUser) {
        alert('Not signed in. Please refresh and sign in again.');
        return;
    }
    
    const game = games.find(g => g.key === currentGameKey);
    if (!game) {
        alert('Game not found');
        return;
    }
    
    // Find the opponent's game card (reverse matchup)
    const opponentGame = games.find(g => 
        g.team === game.opponent && 
        g.opponent === game.team && 
        g.date === game.date &&
        g.key !== game.key
    );
    
    const margin = ts - os;
    const analysis = calcFitScore(game);
    
    const resultData = {
        team: game.team,
        opponent: game.opponent,
        date: game.date,
        spread: game.spread,
        moneyline: game.moneyline,
        spreadMoneyPct: game.spreadMoneyPct || game.spreadPct,
        mlMoneyPct: game.mlMoneyPct || game.mlPct,
        teamScore: ts,
        oppScore: os,
        margin: margin,
        spreadResult: (margin + game.spread > 0) ? 'WIN' : 'LOSS',
        mlResult: margin > 0 ? 'WIN' : 'LOSS',
        fitScore: analysis.score,
        spreadGap: analysis.spreadGap,
        mlGap: analysis.mlGap,
        aligned: analysis.aligned,
        loggedBy: currentUser.email,
        loggedAt: Date.now()
    };
    
    game.result = {
        teamScore: ts,
        oppScore: os,
        spreadResult: resultData.spreadResult,
        mlResult: resultData.mlResult
    };
    
    console.log('Attempting to save result:', resultData);
    console.log('Current user:', currentUser.email);
    
    const promises = [
        db.ref('games/' + game.key + '/result').set(game.result),
        db.ref('results').push(resultData)
    ];
    
    // If opponent game exists, save result there too (with flipped scores)
    if (opponentGame) {
        const oppMargin = os - ts;
        const oppAnalysis = calcFitScore(opponentGame);
        
        const oppResultData = {
            team: opponentGame.team,
            opponent: opponentGame.opponent,
            date: opponentGame.date,
            spread: opponentGame.spread,
            moneyline: opponentGame.moneyline,
            spreadMoneyPct: opponentGame.spreadMoneyPct || opponentGame.spreadPct,
            mlMoneyPct: opponentGame.mlMoneyPct || opponentGame.mlPct,
            teamScore: os,
            oppScore: ts,
            margin: oppMargin,
            spreadResult: (oppMargin + opponentGame.spread > 0) ? 'WIN' : 'LOSS',
            mlResult: oppMargin > 0 ? 'WIN' : 'LOSS',
            fitScore: oppAnalysis.score,
            spreadGap: oppAnalysis.spreadGap,
            mlGap: oppAnalysis.mlGap,
            aligned: oppAnalysis.aligned,
            loggedBy: currentUser.email,
            loggedAt: Date.now()
        };
        
        opponentGame.result = {
            teamScore: os,
            oppScore: ts,
            spreadResult: oppResultData.spreadResult,
            mlResult: oppResultData.mlResult
        };
        
        promises.push(db.ref('games/' + opponentGame.key + '/result').set(opponentGame.result));
        promises.push(db.ref('results').push(oppResultData));
        
        console.log('Also saving opponent game result:', oppResultData);
    }
    
    Promise.all(promises)
        .then(() => {
            console.log('‚úì Result(s) saved successfully');
            closeModal();
            alert(opponentGame ? 'Results saved for both teams!' : 'Result saved!');
        })
        .catch(err => {
            console.error('‚ùå Save failed:', err);
            console.error('Error code:', err.code);
            console.error('Error message:', err.message);
            
            if (err.code === 'PERMISSION_DENIED') {
                alert('Permission denied. Firebase security rules may be blocking writes. Check Firebase console > Realtime Database > Rules.');
            } else {
                alert('Failed to save: ' + err.message);
            }
        });
}

// Render
function render() {
    renderPerformance();
    renderGames();
}

function renderPerformance() {
    const qualified = results.filter(r => r.fitScore > 0);
    if (qualified.length === 0) {
        document.getElementById('perf-dash').innerHTML = '';
        return;
    }
    
    let sW = 0, sT = 0, mW = 0, mT = 0, sP = 0, mP = 0;
    
    qualified.forEach(r => {
        if (r.spreadGap > 0) {
            sT++;
            if (r.spreadResult === 'WIN') { sW++; sP += 100; } else { sP -= 110; }
        }
        if (r.mlGap > 0) {
            mT++;
            if (r.mlResult === 'WIN') {
                mW++;
                const ml = r.moneyline;
                mP += ml > 0 ? ml : (100/Math.abs(ml))*100;
            } else {
                mP -= 100;
            }
        }
    });
    
    const total = sP + mP;
    const html = `
        <div class="card" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white;">
            <h3 style="margin-bottom: 16px;">System Performance</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">Spread</div>
                    <div style="font-size: 24px; font-weight: 900;">${sW}-${sT-sW}</div>
                    <div style="font-size: 12px;">${sT > 0 ? ((sW/sT)*100).toFixed(0) : 0}%</div>
                </div>
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">ML</div>
                    <div style="font-size: 24px; font-weight: 900;">${mW}-${mT-mW}</div>
                    <div style="font-size: 12px;">${mT > 0 ? ((mW/mT)*100).toFixed(0) : 0}%</div>
                </div>
                <div>
                    <div style="font-size: 12px; opacity: 0.8;">Profit</div>
                    <div style="font-size: 24px; font-weight: 900;">${total >= 0 ? '+' : ''}$${total.toFixed(0)}</div>
                    <div style="font-size: 12px;">${qualified.length} games</div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('perf-dash').innerHTML = html;
}

function renderGames() {
    const sorted = [...games].sort((a, b) => {
        const aScore = calcFitScore(a).score;
        const bScore = calcFitScore(b).score;
        return bScore - aScore;
    });
    
    if (sorted.length === 0) {
        document.getElementById('games-container').innerHTML = '<div class="card"><p style="text-align: center; color: #94a3b8;">No games yet. Import from SBD above.</p></div>';
        return;
    }
    
    let html = '';
    sorted.forEach((game, i) => {
        const analysis = calcFitScore(game);
        const spreadPct = game.spreadMoneyPct || game.spreadPct || 0;
        const mlPct = game.mlMoneyPct || game.mlPct || 0;
        const tier = analysis.score >= 50 ? 'high' : analysis.score >= 25 ? 'med' : '';
        const scoreClass = analysis.score >= 50 ? 'high' : analysis.score >= 25 ? 'med' : '';
        
        html += `
            <div class="game-card ${tier}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="background: rgba(148, 163, 184, 0.2); color: #94a3b8; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;">#${i+1}</span>
                            <span style="font-size: 24px; font-weight: 900; color: white;">${game.team}</span>
                        </div>
                        <div style="color: #94a3b8; font-size: 14px; margin-bottom: 8px;">
                            ${game.spread > 0 ? '+' : ''}${game.spread} vs ${game.opponent} ‚Ä¢ ML ${game.moneyline > 0 ? '+' : ''}${game.moneyline}
                        </div>
                        ${analysis.aligned ? '<span style="background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; display: inline-block;">‚≠ê ALIGNED</span>' : ''}
                    </div>
                    <div style="text-align: right;">
                        <div class="score ${scoreClass}">${analysis.score}</div>
                        <div style="font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">FIT</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div class="stat-box">
                        <div style="font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">SPREAD ${analysis.spreadGap > 0 ? '‚úÖ' : ''}</div>
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">Expected: <span style="color: white; font-weight: 600;">50%</span></div>
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Actual: <span style="color: white; font-weight: 600;">${spreadPct}%</span></div>
                        <div style="font-size: 15px; font-weight: 700; color: ${analysis.spreadGap > 0 ? '#10b981' : '#ef4444'};">
                            Gap: ${analysis.spreadGap > 0 ? '+' : ''}${analysis.spreadGap}%
                        </div>
                    </div>
                    <div class="stat-box">
                        <div style="font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">MONEYLINE ${analysis.mlGap > 0 ? '‚úÖ' : ''}</div>
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 4px;">Expected: <span style="color: white; font-weight: 600;">${calcMLBaseline(game.spread).toFixed(1)}%</span></div>
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Actual: <span style="color: white; font-weight: 600;">${mlPct}%</span></div>
                        <div style="font-size: 15px; font-weight: 700; color: ${analysis.mlGap > 0 ? '#10b981' : '#ef4444'};">
                            Gap: ${analysis.mlGap > 0 ? '+' : ''}${analysis.mlGap}%
                        </div>
                    </div>
                </div>
                ${game.result ? `
                    <div style="padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.15);">
                        <div style="font-weight: 700; margin-bottom: 10px; color: white; font-size: 15px;">${game.team} ${game.result.teamScore}-${game.result.oppScore} ${game.opponent}</div>
                        <div style="display: flex; gap: 8px;">
                            <span style="background: ${game.result.spreadResult === 'WIN' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${game.result.spreadResult === 'WIN' ? '#10b981' : '#ef4444'}; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; border: 1px solid ${game.result.spreadResult === 'WIN' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">ATS: ${game.result.spreadResult}</span>
                            <span style="background: ${game.result.mlResult === 'WIN' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${game.result.mlResult === 'WIN' ? '#10b981' : '#ef4444'}; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 700; border: 1px solid ${game.result.mlResult === 'WIN' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};">ML: ${game.result.mlResult}</span>
                        </div>
                    </div>
                ` : `
                    <button onclick="openModal('${game.key}')" class="btn-primary" style="width: 100%;">Log Result</button>
                `}
            </div>
        `;
    });
    
    document.getElementById('games-container').innerHTML = html;
}

// Set today's date
document.getElementById('game-date').valueAsDate = new Date();
</script>

</body>
</html>
