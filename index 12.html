<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="dark-content">
    <title>NBA Edge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; min-height: 100vh; padding-bottom: 40px; }
        .card { background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .btn-primary { background: #1d9461; color: #fff; border: none; border-radius: 10px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .btn-primary:active { background: #167a50; }
        .btn-secondary { background: #eee; color: #333; border: none; border-radius: 10px; padding: 12px 20px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .btn-danger { background: #dc2626; color: #fff; border: none; border-radius: 10px; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-danger:active { background: #b91c1c; }
        .game-card { border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 5px solid #ccc; background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.05); }
        .game-card.strong { border-left-color: #16a34a; background: #f0fdf4; }
        .game-card.medium { border-left-color: #ca8a04; background: #fefce8; }
        .game-card.weak { border-left-color: #d1d5db; background: #fff; }
        .badge { display: inline-block; background: #16a34a; color: #fff; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 20px; letter-spacing: 0.3px; }
        .score-box { text-align: right; }
        .score-num { font-size: 32px; font-weight: 700; line-height: 1; }
        .score-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
        .stat-row .label { color: #666; }
        .stat-row .value { font-weight: 600; }
        .gap-positive { color: #16a34a; font-weight: 700; }
        .gap-negative { color: #dc2626; font-weight: 700; }
        textarea { width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 10px; padding: 12px; font-size: 13px; font-family: monospace; resize: vertical; outline: none; -webkit-appearance: none; }
        textarea:focus { border-color: #1d9461; box-shadow: 0 0 0 3px rgba(29,148,97,0.15); }
        input[type="date"] { border: 1px solid #ddd; border-radius: 10px; padding: 10px 12px; font-size: 15px; outline: none; -webkit-appearance: none; background: #fff; }
        input[type="number"] { width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 10px; padding: 12px; font-size: 18px; text-align: center; outline: none; -webkit-appearance: none; }
        input[type="number"]:focus { border-color: #1d9461; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: flex-end; }
        .modal-sheet { background: #fff; border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; margin: 0 auto; padding: 24px; max-height: 80vh; overflow-y: auto; }
        .modal-handle { width: 40px; height: 4px; background: #ddd; border-radius: 2px; margin: 0 auto 20px; }
        .perf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .perf-card { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 14px; }
        .perf-card .perf-label { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.3px; }
        .perf-card .perf-value { font-size: 22px; font-weight: 700; margin-top: 2px; }
        .perf-card .perf-sub { font-size: 12px; opacity: 0.7; margin-top: 2px; }
        .header-bar { background: #fff; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
        .last-updated { font-size: 11px; color: #999; text-align: center; padding: 8px 0 4px; }
        .split-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .mini-stat { background: #f7f7f7; border-radius: 10px; padding: 10px 12px; border: 1px solid #eee; }
        .mini-stat .ms-title { font-size: 11px; font-weight: 700; color: #444; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
        .mini-stat .ms-row { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-bottom: 2px; }
        .mini-stat .ms-gap { font-size: 14px; font-weight: 700; margin-top: 4px; }
        .result-row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
        .result-pill { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 20px; }
        .result-pill.win { background: #dcfce7; color: #16a34a; }
        .result-pill.loss { background: #fee2e2; color: #dc2626; }
        .import-section { padding: 20px; }
        .section-title { font-size: 13px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; padding: 16px 20px 8px; }
    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <div style="max-width: 360px; margin: 100px auto 0; padding: 0 24px; text-align: center;">
        <div style="width: 72px; height: 72px; background: linear-gradient(135deg, #1d9461, #2563eb); border-radius: 18px; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 36px;">üèÄ</span>
        </div>
        <h1 style="font-size: 28px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px;">NBA Edge</h1>
        <p style="color: #888; font-size: 15px; margin-bottom: 32px;">Contrarian betting edge tracker for your group</p>
        <button onclick="signInWithGoogle()" style="width: 100%; background: #fff; border: 1.5px solid #ddd; border-radius: 12px; padding: 14px; font-size: 16px; font-weight: 600; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
        </button>
        <p style="font-size: 12px; color: #aaa; margin-top: 20px;">Shared data across your group</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="hidden">
    <!-- Header -->
    <div class="header-bar">
        <div style="font-size: 18px; font-weight: 700; color: #1a1a1a;">üèÄ NBA Edge</div>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button onclick="showAnalytics()" style="font-size: 22px; cursor: pointer; background: none; border: none; padding: 4px;">üìä</button>
            <button onclick="signOut()" style="font-size: 13px; color: #999; cursor: pointer; background: none; border: none; font-weight: 600;">Out</button>
        </div>
    </div>

    <!-- Last Updated -->
    <div class="last-updated" id="last-updated-text">Last updated: ‚Äî</div>

    <!-- Performance Dashboard -->
    <div id="performance-dashboard" style="padding: 0 16px;"></div>

    <!-- Import Section -->
    <div class="card" style="margin: 12px 16px 0;">
        <div style="padding: 18px 18px 8px;">
            <div style="font-size: 15px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px;">Import from SBD</div>
            <div style="font-size: 12px; color: #999;">Paste spread table, then moneyline table</div>
        </div>
        <div style="padding: 0 18px;">
            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 6px; margin-top: 14px;">SPREAD Data</label>
            <textarea id="spread-paste" rows="5" placeholder="Paste spread table here..."></textarea>
            <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 6px; margin-top: 14px;">MONEYLINE Data</label>
            <textarea id="ml-paste" rows="5" placeholder="Paste moneyline table here..."></textarea>
        </div>
        <div style="padding: 14px 18px 18px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="date" id="bulk-date">
            <button onclick="importFromSBD()" class="btn-primary" style="flex: 1; min-width: 120px;">Import</button>
            <button onclick="clearAllGames()" class="btn-danger" title="Clears upcoming games but keeps logged results">Clear Games</button>
        </div>
    </div>

    <!-- Games List -->
    <div id="games-list" style="padding: 12px 16px 0;"></div>

    <!-- Result Modal (bottom sheet) -->
    <div id="result-modal" class="modal-overlay hidden" onclick="closeModalOutside(event)">
        <div class="modal-sheet">
            <div class="modal-handle"></div>
            <h3 style="font-size: 18px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px;">Log Result</h3>
            <p id="modal-matchup" style="color: #888; font-size: 14px; margin-bottom: 20px;"></p>
            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label id="team-label" style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;"></label>
                    <input type="number" id="team-score" placeholder="0">
                </div>
                <div style="flex: 1;">
                    <label id="opp-label" style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;"></label>
                    <input type="number" id="opp-score" placeholder="0">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="saveResult()" class="btn-primary" style="flex: 1;">Save Result</button>
                <button onclick="closeModal()" class="btn-secondary" style="flex: 0.6;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal-overlay hidden" onclick="closeAnalyticsOutside(event)">
        <div class="modal-sheet" style="max-height: 85vh;">
            <div class="modal-handle"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
                <h3 style="font-size: 18px; font-weight: 700; color: #1a1a1a;">üìä Analytics</h3>
                <button onclick="closeAnalytics()" style="font-size: 22px; color: #999; background: none; border: none; cursor: pointer;">&times;</button>
            </div>
            <div id="analytics-content"></div>
        </div>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyB8EmsdGFvQLRRWev3zM8wzSXXhgWjHeO4",
        authDomain: "nba-tracker-641f0.firebaseapp.com",
        databaseURL: "https://nba-tracker-641f0-default-rtdb.firebaseio.com",
        projectId: "nba-tracker-641f0",
        storageBucket: "nba-tracker-641f0.firebasestorage.app",
        messagingSenderId: "29717054876",
        appId: "1:29717054876:web:fc4bf3d1242967fe857459"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    let currentUser = null;
    let games = [];
    let results = []; // Permanent results storage
    let currentGameId = null;
    const THRESHOLD = 20;

    // Handle redirect result
    auth.getRedirectResult().then(result => {
        if (result.user) console.log('Signed in via redirect');
    }).catch(e => console.error('Redirect:', e));

    // Auth observer
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            loadGamesFromFirebase();
        } else {
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
    });

    // Sign in
    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(() => {
            auth.signInWithRedirect(provider);
        });
    }

    function signOut() { auth.signOut(); }

    // Firebase CRUD
    function loadGamesFromFirebase() {
        database.ref('games').on('value', snapshot => {
            games = [];
            snapshot.forEach(child => {
                games.push({ firebaseKey: child.key, ...child.val() });
            });
            render();
        });
        
        // Also load permanent results
        database.ref('results').on('value', snapshot => {
            results = [];
            snapshot.forEach(child => {
                results.push({ firebaseKey: child.key, ...child.val() });
            });
            render();
        });
    }

    function saveGameToFirebase(game) {
        const d = {...game};
        delete d.firebaseKey;
        return game.firebaseKey
            ? database.ref('games/' + game.firebaseKey).update(d)
            : database.ref('games').push(d);
    }

    function deleteGameFromFirebase(key) {
        return database.ref('games/' + key).remove();
    }

    // Scoring
    function calculateMLBaseline(spread) {
        return Math.max(5, Math.min(95, 50 + (parseFloat(spread) * -2.8)));
    }

    function calculateFitScore(game) {
        const spreadBaseline = 50;
        const mlBaseline = calculateMLBaseline(game.spread);
        const spreadGap = spreadBaseline - game.spreadMoneyPct;
        const mlGap = mlBaseline - game.mlMoneyPct;
        const weightedScore = (spreadGap * 0.75) + (mlGap * 0.25);
        const baseScore = Math.max(0, weightedScore * 1.5);
        const bothPositive = spreadGap > 0 && mlGap > 0;
        const alignmentBonus = bothPositive ? 10 : 0;
        return {
            score: Math.round((baseScore + alignmentBonus) * 10) / 10,
            spreadBaseline,
            mlBaseline: Math.round(mlBaseline * 10) / 10,
            spreadGap: Math.round(spreadGap * 10) / 10,
            mlGap: Math.round(mlGap * 10) / 10,
            bothPositive,
            recommendation: (mlGap > 10 || spreadGap > 10) ? 'BOTH' : (spreadGap > mlGap ? 'SPREAD' : 'ML')
        };
    }

    // Parser
    function parseSBDTable(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l);
        const games = [];
        let i = 0;
        while (i < lines.length) {
            const teamMatch = lines[i].match(/logo([A-Z]{2,4})$/);
            if (teamMatch) {
                const team = teamMatch[1];
                i++;
                while (i < lines.length && lines[i].toLowerCase().includes('logo')) i++;
                if (i >= lines.length) break;
                let lineValue = lines[i].replace('‚àí', '-').replace('+', '');
                const parsedLine = parseFloat(lineValue);
                if (isNaN(parsedLine)) { i++; continue; }
                i++;
                if (i >= lines.length) break;
                i++; // skip BET%
                if (i >= lines.length) break;
                const moneyPct = parseFloat(lines[i].replace('%', ''));
                if (isNaN(moneyPct)) { i++; continue; }
                games.push({ team, opponent: 'Unknown', line: parsedLine, moneyPct });
            }
            i++;
        }
        return games;
    }

    // Import
    function importFromSBD() {
        const spreadText = document.getElementById('spread-paste').value.trim();
        const mlText = document.getElementById('ml-paste').value.trim();
        const gameDate = document.getElementById('bulk-date').value;
        if (!spreadText || !mlText) { showToast('Paste both spread and ML data', '#dc2626'); return; }
        try {
            const spreadData = parseSBDTable(spreadText);
            const mlData = parseSBDTable(mlText);
            if (spreadData.length === 0 || mlData.length === 0) {
                showToast('Parse failed: ' + spreadData.length + ' spread, ' + mlData.length + ' ML', '#dc2626');
                return;
            }
            // Pair opponents
            for (let i = 0; i < spreadData.length; i += 2) {
                if (i + 1 < spreadData.length) {
                    spreadData[i].opponent = spreadData[i+1].team;
                    spreadData[i+1].opponent = spreadData[i].team;
                }
            }
            for (let i = 0; i < mlData.length; i += 2) {
                if (i + 1 < mlData.length) {
                    mlData[i].opponent = mlData[i+1].team;
                    mlData[i+1].opponent = mlData[i].team;
                }
            }
            // Delete existing for this date, then import
            const delPromises = games.filter(g => g.date === gameDate && g.firebaseKey).map(g => database.ref('games/' + g.firebaseKey).remove());
            Promise.all(delPromises).then(() => {
                let imported = 0;
                const promises = [];
                for (let i = 0; i < spreadData.length; i++) {
                    const spread = spreadData[i];
                    const ml = mlData.find(m => m.team === spread.team);
                    if (!ml) continue;
                    promises.push(saveGameToFirebase({
                        id: Date.now() + i,
                        team: spread.team,
                        opponent: spread.opponent,
                        spread: spread.line,
                        moneyline: ml.line,
                        spreadMoneyPct: spread.moneyPct,
                        mlMoneyPct: ml.moneyPct,
                        date: gameDate || new Date().toISOString().split('T')[0],
                        addedBy: currentUser.email,
                        addedAt: Date.now()
                    }));
                    imported++;
                }
                Promise.all(promises).then(() => {
                    document.getElementById('spread-paste').value = '';
                    document.getElementById('ml-paste').value = '';
                    showToast('Imported ' + imported + ' games!', '#1d9461');
                });
            });
        } catch (e) {
            showToast('Error: ' + e.message, '#dc2626');
        }
    }

    function clearAllGames() {
        if (confirm('Clear all games? (Logged results will be kept for performance tracking)')) {
            database.ref('games').remove().then(() => showToast('Games cleared! Results kept.', '#1d9461'));
        }
    }

    // Toast
    function showToast(msg, bg) {
        const t = document.createElement('div');
        t.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);background:' + bg + ';color:#fff;padding:12px 24px;border-radius:24px;font-weight:600;z-index:999;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.2);';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2800);
    }

    // Result Modal
    function openResultModal(key) {
        const game = games.find(g => g.firebaseKey === key);
        currentGameId = key;
        document.getElementById('modal-matchup').textContent = game.team + ' vs ' + game.opponent + ' | ' + (game.spread > 0 ? '+' : '') + game.spread;
        document.getElementById('team-label').textContent = game.team + ' Score';
        document.getElementById('opp-label').textContent = game.opponent + ' Score';
        document.getElementById('result-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('result-modal').classList.add('hidden');
        currentGameId = null;
        document.getElementById('team-score').value = '';
        document.getElementById('opp-score').value = '';
    }

    function closeModalOutside(e) { if (e.target === document.getElementById('result-modal')) closeModal(); }

    function saveResult() {
        const ts = parseInt(document.getElementById('team-score').value);
        const os = parseInt(document.getElementById('opp-score').value);
        if (isNaN(ts) || isNaN(os)) { showToast('Enter both scores', '#dc2626'); return; }
        const game = games.find(g => g.firebaseKey === currentGameId);
        const margin = ts - os;
        const analysis = calculateFitScore(game);
        
        // Save result to BOTH game and permanent results collection
        const resultData = {
            team: game.team,
            opponent: game.opponent,
            date: game.date,
            spread: game.spread,
            moneyline: game.moneyline,
            spreadMoneyPct: game.spreadMoneyPct,
            mlMoneyPct: game.mlMoneyPct,
            teamScore: ts,
            oppScore: os,
            margin: margin,
            spreadResult: (margin + game.spread > 0) ? 'WIN' : 'LOSS',
            mlResult: margin > 0 ? 'WIN' : 'LOSS',
            fitScore: analysis.score,
            recommendation: analysis.recommendation,
            spreadGap: analysis.spreadGap,
            mlGap: analysis.mlGap,
            bothAligned: analysis.bothPositive,
            loggedBy: currentUser.email,
            loggedAt: Date.now()
        };
        
        game.result = {
            teamScore: ts, oppScore: os, margin,
            spreadResult: resultData.spreadResult,
            mlResult: resultData.mlResult,
            loggedBy: currentUser.email, loggedAt: Date.now()
        };
        
        // Save to both locations: update game + add to permanent results
        Promise.all([
            saveGameToFirebase(game),
            database.ref('results').push(resultData)
        ]).then(() => { 
            closeModal(); 
            showToast('Result locked in! üîí', '#1d9461'); 
        });
    }

    function deleteGame(key) {
        if (confirm('Delete this game?')) deleteGameFromFirebase(key);
    }

    // Performance
    function calculatePerformance() {
        // Use permanent results collection instead of games
        const qualified = results.filter(r => r.fitScore >= THRESHOLD);
        if (qualified.length === 0) return null;
        
        let sW = 0, sT = 0, mW = 0, mT = 0, sP = 0, mP = 0;
        qualified.forEach(result => {
            if (result.recommendation === 'SPREAD' || result.recommendation === 'BOTH') {
                sT++;
                if (result.spreadResult === 'WIN') { sW++; sP += 100; } 
                else { sP -= 110; }
            }
            if (result.recommendation === 'ML' || result.recommendation === 'BOTH') {
                mT++;
                if (result.mlResult === 'WIN') { 
                    mW++; 
                    const ml = result.moneyline;
                    mP += ml > 0 ? ml : (100/Math.abs(ml))*100; 
                } else { 
                    mP -= 100; 
                }
            }
        });
        
        return {
            spreadRecord: sW+'-'+(sT-sW), 
            spreadWinPct: sT > 0 ? ((sW/sT)*100).toFixed(1) : 0, 
            spreadROI: sT > 0 ? ((sP/(sT*100))*100).toFixed(1) : 0,
            mlRecord: mW+'-'+(mT-mW), 
            mlWinPct: mT > 0 ? ((mW/mT)*100).toFixed(1) : 0, 
            mlROI: mT > 0 ? ((mP/(mT*100))*100).toFixed(1) : 0,
            totalGames: qualified.length, 
            totalProfit: sP + mP
        };
    }

    // Analytics
    function showAnalytics() {
        // Use permanent results instead of games
        if (results.length === 0) { showToast('No results logged yet', '#888'); return; }
        
        const ranges = { '0-20': [], '20-30': [], '30-40': [], '40-50': [], '50+': [] };
        results.forEach(r => {
            const s = r.fitScore;
            if (s < 20) ranges['0-20'].push(r);
            else if (s < 30) ranges['20-30'].push(r);
            else if (s < 40) ranges['30-40'].push(r);
            else if (s < 50) ranges['40-50'].push(r);
            else ranges['50+'].push(r);
        });
        
        let html = '<div style="font-size:13px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Performance by Score Range</div>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px;">';
        Object.entries(ranges).forEach(([range, arr]) => {
            if (!arr.length) return;
            let w = 0;
            arr.forEach(r => { 
                if (r.recommendation === 'SPREAD' || r.recommendation === 'BOTH') {
                    if (r.spreadResult === 'WIN') w++;
                }
                if (r.recommendation === 'ML' || r.recommendation === 'BOTH') {
                    if (r.mlResult === 'WIN') w++;
                }
            });
            html += `<div style="background:#f7f7f7;border-radius:12px;padding:14px;border:1px solid #eee;">
                <div style="font-size:13px;font-weight:700;color:#444;">${range}</div>
                <div style="font-size:22px;font-weight:700;margin-top:4px;">${w}-${arr.length-w}</div>
                <div style="font-size:12px;color:#888;">${arr.length ? ((w/arr.length)*100).toFixed(0) : 0}%</div>
            </div>`;
        });
        html += '</div>';
        
        const aligned = results.filter(r => r.bothAligned);
        const notAligned = results.filter(r => !r.bothAligned);
        let aw = 0, nw = 0;
        aligned.forEach(r => { if (r.spreadResult === 'WIN' || r.mlResult === 'WIN') aw++; });
        notAligned.forEach(r => { if (r.spreadResult === 'WIN' || r.mlResult === 'WIN') nw++; });
        
        html += '<div style="font-size:13px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Alignment Impact ‚≠ê</div>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
        html += `<div style="background:#f0fdf4;border-radius:12px;padding:14px;border:1px solid #bbf7d0;">
            <div style="font-size:12px;font-weight:600;color:#16a34a;">Both Aligned</div>
            <div style="font-size:22px;font-weight:700;margin-top:4px;">${aw}-${aligned.length-aw}</div>
            <div style="font-size:12px;color:#888;">${aligned.length ? ((aw/aligned.length)*100).toFixed(0) : 0}%</div>
        </div>`;
        html += `<div style="background:#f7f7f7;border-radius:12px;padding:14px;border:1px solid #eee;">
            <div style="font-size:12px;font-weight:600;color:#666;">Not Aligned</div>
            <div style="font-size:22px;font-weight:700;margin-top:4px;">${nw}-${notAligned.length-nw}</div>
            <div style="font-size:12px;color:#888;">${notAligned.length ? ((nw/notAligned.length)*100).toFixed(0) : 0}%</div>
        </div>`;
        html += '</div>';
        
        document.getElementById('analytics-content').innerHTML = html;
        document.getElementById('analytics-modal').classList.remove('hidden');
    }

    function closeAnalytics() { document.getElementById('analytics-modal').classList.add('hidden'); }
    function closeAnalyticsOutside(e) { if (e.target === document.getElementById('analytics-modal')) closeAnalytics(); }

    // Render
    function renderPerformance() {
        const perf = calculatePerformance();
        const c = document.getElementById('performance-dashboard');
        if (!perf) { c.innerHTML = ''; return; }
        const pColor = perf.totalProfit >= 0 ? '#86efac' : '#fca5a5';
        c.innerHTML = `<div style="background:linear-gradient(135deg,#1d9461,#1e6f9a);border-radius:16px;padding:18px;margin-bottom:4px;">
            <div style="color:#fff;font-size:13px;font-weight:600;opacity:0.85;margin-bottom:12px;">SYSTEM PERFORMANCE (Score ‚â•${THRESHOLD})</div>
            <div class="perf-grid">
                <div class="perf-card"><div class="perf-label" style="color:rgba(255,255,255,0.7);">Spread</div><div class="perf-value" style="color:#fff;">${perf.spreadRecord}</div><div class="perf-sub" style="color:rgba(255,255,255,0.6);">${perf.spreadWinPct}% ¬∑ ${perf.spreadROI}% ROI</div></div>
                <div class="perf-card"><div class="perf-label" style="color:rgba(255,255,255,0.7);">Moneyline</div><div class="perf-value" style="color:#fff;">${perf.mlRecord}</div><div class="perf-sub" style="color:rgba(255,255,255,0.6);">${perf.mlWinPct}% ¬∑ ${perf.mlROI}% ROI</div></div>
                <div class="perf-card"><div class="perf-label" style="color:rgba(255,255,255,0.7);">Profit</div><div class="perf-value" style="color:${pColor};">${perf.totalProfit >= 0 ? '+' : ''}$${perf.totalProfit.toFixed(0)}</div><div class="perf-sub" style="color:rgba(255,255,255,0.6);">$100 units</div></div>
                <div class="perf-card"><div class="perf-label" style="color:rgba(255,255,255,0.7);">Games</div><div class="perf-value" style="color:#fff;">${perf.totalGames}</div><div class="perf-sub" style="color:rgba(255,255,255,0.6);">Qualified</div></div>
            </div>
        </div>`;
    }

    function renderGamesList() {
        const c = document.getElementById('games-list');
        const sorted = [...games].sort((a, b) => calculateFitScore(b).score - calculateFitScore(a).score);

        // Update "last updated" timestamp
        if (sorted.length > 0) {
            const mostRecent = Math.max(...sorted.map(g => g.addedAt || 0));
            if (mostRecent > 0) {
                const d = new Date(mostRecent);
                document.getElementById('last-updated-text').textContent = 'Last updated: ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' at ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            }
        }

        if (sorted.length === 0) {
            c.innerHTML = '<div class="card" style="padding:48px 24px;text-align:center;margin-top:8px;"><div style="font-size:40px;margin-bottom:12px;">üìã</div><div style="color:#999;font-size:15px;">No games yet. Import from SBD above!</div></div>';
            return;
        }

        c.innerHTML = sorted.map((game, idx) => {
            const a = calculateFitScore(game);
            const tier = a.score >= 50 ? 'strong' : a.score >= 25 ? 'medium' : 'weak';
            const scoreColor = a.score >= 50 ? '#16a34a' : a.score >= 25 ? '#ca8a04' : '#666';
            let html = `<div class="game-card ${tier}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                    <div>
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                            <span style="font-size:13px;font-weight:600;color:#999;">#${idx+1}</span>
                            <span style="font-size:20px;font-weight:700;color:#1a1a1a;">${game.team}</span>
                            ${a.bothPositive ? '<span class="badge">‚≠ê BOTH ALIGNED</span>' : ''}
                        </div>
                        <div style="font-size:13px;color:#888;margin-top:4px;">
                            ${game.spread > 0 ? '+' : ''}${game.spread} vs ${game.opponent} &nbsp;|&nbsp; ML ${game.moneyline > 0 ? '+' : ''}${game.moneyline}
                        </div>
                    </div>
                    <div class="score-box">
                        <div class="score-num" style="color:${scoreColor};">${a.score}</div>
                        <div class="score-label">Fit Score</div>
                    </div>
                </div>
                <div class="split-box" style="margin-top:14px;">
                    <div class="mini-stat">
                        <div class="ms-title">Spread ${a.recommendation === 'SPREAD' || a.recommendation === 'BOTH' ? '‚úÖ' : ''}</div>
                        <div class="ms-row"><span>Expected</span><span>${a.spreadBaseline}%</span></div>
                        <div class="ms-row"><span>Actual $%</span><span>${game.spreadMoneyPct}%</span></div>
                        <div class="ms-gap ${a.spreadGap > 0 ? 'gap-positive' : 'gap-negative'}">${a.spreadGap > 0 ? '+' : ''}${a.spreadGap}%</div>
                    </div>
                    <div class="mini-stat">
                        <div class="ms-title">Moneyline ${a.recommendation === 'ML' || a.recommendation === 'BOTH' ? '‚úÖ' : ''}</div>
                        <div class="ms-row"><span>Expected</span><span>${a.mlBaseline}%</span></div>
                        <div class="ms-row"><span>Actual $%</span><span>${game.mlMoneyPct}%</span></div>
                        <div class="ms-gap ${a.mlGap > 0 ? 'gap-positive' : 'gap-negative'}">${a.mlGap > 0 ? '+' : ''}${a.mlGap}%</div>
                    </div>
                </div>`;
            if (game.result) {
                html += `<div style="margin-top:14px;padding-top:12px;border-top:1px solid #eee;">
                    <div style="font-size:14px;font-weight:600;color:#1a1a1a;">${game.team} ${game.result.teamScore} ‚Äì ${game.result.oppScore} ${game.opponent}</div>
                    <div class="result-row">
                        <span class="result-pill ${game.result.spreadResult === 'WIN' ? 'win' : 'loss'}">ATS: ${game.result.spreadResult}</span>
                        <span class="result-pill ${game.result.mlResult === 'WIN' ? 'win' : 'loss'}">ML: ${game.result.mlResult}</span>
                    </div>
                </div>`;
            } else {
                html += `<div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center;">
                    <button onclick="openResultModal('${game.firebaseKey}')" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:10px 18px;font-size:14px;font-weight:600;cursor:pointer;">Log Result</button>
                    <button onclick="deleteGame('${game.firebaseKey}')" style="background:none;border:none;color:#dc2626;font-size:13px;font-weight:600;cursor:pointer;">Delete</button>
                </div>`;
            }
            html += '</div>';
            return html;
        }).join('');
    }

    function render() {
        try {
            renderPerformance();
            renderGamesList();
        } catch(e) {
            const d = document.createElement('div');
            d.style.cssText = 'position:fixed;top:60px;left:10px;right:10px;background:red;color:white;padding:16px;border-radius:8px;z-index:9999;font-size:14px;white-space:pre-wrap;max-height:300px;overflow:auto;';
            d.textContent = 'ERROR:\n' + e.message + '\n' + e.stack;
            document.body.appendChild(d);
        }
    }

    document.getElementById('bulk-date').valueAsDate = new Date();
</script>
</body>
</html>
